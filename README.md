# Orderer Map client-server application | Golang

This repository contains a Golang implementation of a client-server application that uses an external queue for handling requests and an ordered map data structure to keep the order of items added.

## Prerequisites
1. You need to have docker installed in your system
2. A working directory is required - for example, Go Developers use the ```$HOME/go/src/github.com/<your_github_userid>``` directory. This is a Golang Community recommendation for Go projects.
## Usage

1. Clone repository to your $HOME/go/src/github.com <your_github_userid> location
2. Move inside cloned directory
3. Run the RabbitMQ instance
   ```bash
   docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.11-management
   ```
4. Run the server (by default it uses the default rabbitmq address, port, and needed queue and use default file with the name "server.log")
   ```
   go run server
   ```
5. Run the client with one action to test the correctness of the connection.
   ```bash
    go run client -action=add -key=k1 -value=v1
   ```
   You should be able to see this entry message log inside server.log file.

   To use the file as a data input, it should be generated by the testDataGenerator template.

## Multiple clients test
To test parallel writing to the message queue different files with different key ranges could be generated. The clients could start to send messages simultaneously, and parallel writing will be tested as well as data consistency.

Example of several client execution:
```bash
go run testDataGenerator -min=0 -max=20 -file=testdata0-20.json -amount=10000
go run testDataGenerator -min=30 -max=50 -file=testdata30-50.json -amount=10000

go run client -file=testdata0-20.json & go run client -file=testdata30-50.json &
```
Resust will be randomly merged but with correct data order from both files.


## Run unit tests of all modules

```bash
$ go test ./server/... ./client/... ./mq/...
ok      server/logger   0.399s
ok      server/orderer-map      0.577s
ok      server/request-manager  1.502s
ok      client  0.826s
```

To test rabbitmq module the RabbitMQ instance should be run

```bash
$ go test ./mq/...
ok      github.com/enriquenc/orderer-map-client-server-go/mq    1.338s
```

## Modules description
### client
The client performs synchronized writing (to keep the correct order of operations) to the message queue.

```bash
go run client --help

  -action string
        Action to perform: add, remove, get, or getAll
  -key string
        Key to use for the item
  -value string
        Value to use for the item
  -file string
        File name to read actions
  -mq-url string
        RabbitMQ server address (default "amqp://guest:guest@localhost:5672/")
  -queue string
        RabbitMQ queue name (default "requests")

```

It's possible to perform one action per client running as well as from the file.

Send one action:
```bash
go run client -action=add -key=k1 -value=v1
```

Send all the action from file (file format define by the testDataGenerator module)
```bash
go run client -file=testdata.json
```

### server
The server reads data from the message queue and performs the operations in parallel with reading from the queue. There are 2 go routines and the channel between them.

```bash
go run server --help
  -log-file string
        Log file name (default "server.log")
  -mq-url string
        RabbitMQ URL (default "amqp://guest:guest@localhost:5672/")
  -queue string
        RabbitMQ queue name (default "requests")
```

So, to run the server you can just run following command in case all the stuff was installed by default:
```bash
go run server
```


### testDataGenerator
Generates the mentioned amount of data with the expected results for data consistency testing.

```bash
 go run testDataGenerator --help
  -amount int
        Value to use for the item (default 1000)
  -file string
        Value to use for the item (default "testdata.json")
  -max int
        max number from range generated keys and values (default 20)
  -min int
        min number from range generated keys and values (default 0)
```

The data type of generated data:
```golang
type Action struct {
	Command          string
	Key              string
	Value            string
	ExpectedResponse interface{}
}
```

Example of generated data file:
```json
{"Command":"get","Key":"key8","Value":"","ExpectedResponse":null}
{"Command":"add","Key":"key8","Value":"value8","ExpectedResponse":null}
{"Command":"getAll","Key":"key1","Value":"","ExpectedResponse":{"key8":"value8"}}
{"Command":"get","Key":"key7","Value":"","ExpectedResponse":null}
{"Command":"get","Key":"key2","Value":"","ExpectedResponse":null}
{"Command":"add","Key":"key1","Value":"value1","ExpectedResponse":null}
{"Command":"getAll","Key":"key5","Value":"","ExpectedResponse":{"key8":"value8","key1":"value1"}}
{"Command":"get","Key":"key15","Value":"","ExpectedResponse":null}
{"Command":"remove","Key":"key8","Value":"","ExpectedResponse":null}
{"Command":"add","Key":"key14","Value":"value14","ExpectedResponse":null}
{"Command":"add","Key":"key3","Value":"value3","ExpectedResponse":null}
{"Command":"getAll","Key":"key3","Value":"","ExpectedResponse":{"key1":"value1","key14":"value14","key3":"value3"}}
```
